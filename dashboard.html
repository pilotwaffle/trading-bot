<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial Crypto Trading Bot Dashboard</title>
    <!-- Bootstrap, FontAwesome, Chart.js for rich UI and charting -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/dashboard.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <!-- Top Navbar -->
    <nav class="navbar navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-chart-line"></i> Crypto Trading Bot</a>
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-3" id="connection-status">Connected</span>
                <button class="btn btn-outline-light" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid main-container" style="margin-top:56px;">
        <div class="row">
            <!-- Sidebar Navigation -->
            <nav class="col-md-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column" id="nav-sections">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-page="overview"><i class="fas fa-tachometer-alt"></i> Overview</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="positions"><i class="fas fa-wallet"></i> Positions</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="orders"><i class="fas fa-shopping-cart"></i> Orders</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="strategies"><i class="fas fa-brain"></i> Strategies</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="performance"><i class="fas fa-chart-bar"></i> Performance</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="risk"><i class="fas fa-shield-alt"></i> Risk</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="logs"><i class="fas fa-file-alt"></i> Logs</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="ml-train"><i class="fas fa-robot"></i> Train Bot</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="crypto-prices"><i class="fas fa-coins"></i> Crypto Prices</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="system-status"><i class="fas fa-server"></i> System Status</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="chat"><i class="fas fa-comments"></i> Chat</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="settings"><i class="fas fa-cog"></i> Settings</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="col-md-10 ms-sm-auto px-md-4">
                <!-- Each section is a .page-content; only one visible at a time -->
                <!-- Overview/Dashboard -->
                <div id="overview-page" class="page-content">
                    <!-- Bot Controls -->
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-success" id="start-bot-btn" onclick="startBot()">
                                    <i class="fas fa-play"></i> Start Bot
                                </button>
                                <button type="button" class="btn btn-danger" id="stop-bot-btn" onclick="stopBot()" style="display:none;">
                                    <i class="fas fa-stop"></i> Stop Bot
                                </button>
                                <button type="button" class="btn btn-warning" onclick="emergencyStop()">
                                    <i class="fas fa-exclamation-triangle"></i> Emergency Stop
                                </button>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-secondary" onclick="refreshData()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Status Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card status-card">
                                <div class="card-body">
                                    <h5 class="card-title">Total Equity</h5>
                                    <h2 class="card-value" id="total-equity">$0.00</h2>
                                    <small class="text-muted"><span id="equity-change" class="text-success">+0.00%</span> today</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card status-card">
                                <div class="card-body">
                                    <h5 class="card-title">Open Positions</h5>
                                    <h2 class="card-value" id="open-positions">0</h2>
                                    <small class="text-muted">P&L: <span id="positions-pnl" class="text-success">$0.00</span></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card status-card">
                                <div class="card-body">
                                    <h5 class="card-title">Today's Trades</h5>
                                    <h2 class="card-value" id="today-trades">0</h2>
                                    <small class="text-muted">Win Rate: <span id="win-rate">0%</span></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card status-card">
                                <div class="card-body">
                                    <h5 class="card-title">Bot Status</h5>
                                    <h2 class="card-value">
                                        <span id="bot-status" class="badge bg-secondary">Stopped</span>
                                    </h2>
                                    <small class="text-muted">Mode: <span id="bot-mode">Paper</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Equity & Portfolio Charts -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header"><h5 class="mb-0">Equity Curve</h5></div>
                                <div class="card-body"><canvas id="equity-chart" height="300"></canvas></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header"><h5 class="mb-0">Portfolio Allocation</h5></div>
                                <div class="card-body"><canvas id="allocation-chart" height="300"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <!-- Recent Trades & Strategies Table -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header"><h5 class="mb-0">Recent Trades</h5></div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Time</th><th>Symbol</th><th>Side</th><th>Price</th><th>P&L</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recent-trades"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header"><h5 class="mb-0">Active Strategies</h5></div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Strategy</th><th>Status</th><th>Trades</th><th>P&L</th><th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="active-strategies"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Positions Page -->
                <div id="positions-page" class="page-content" style="display:none;">
                    <h3>Current Positions</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Symbol</th><th>Side</th><th>Size</th><th>Entry Price</th><th>Current Price</th>
                                    <th>P&L</th><th>P&L %</th><th>Duration</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="positions-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Page -->
                <div id="orders-page" class="page-content" style="display:none;">
                    <h3>Active Orders</h3>
                    <div class="mb-3">
                        <button class="btn btn-primary" onclick="showCreateOrderModal()"><i class="fas fa-plus"></i> New Order</button>
                        <button class="btn btn-danger" onclick="cancelAllOrders()">Cancel All Orders</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Time</th><th>Symbol</th><th>Type</th><th>Side</th>
                                    <th>Price</th><th>Amount</th><th>Filled</th><th>Status</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Strategies Page -->
                <div id="strategies-page" class="page-content" style="display:none;">
                    <h3>Trading Strategies</h3>
                    <div class="row" id="strategies-list"></div>
                </div>

                <!-- Performance Page -->
                <div id="performance-page" class="page-content" style="display:none;">
                    <h3>Performance Analytics</h3>
                    <div class="row mb-4">
                        <div class="col-md-3"><div class="metric-card"><h6>Total Return</h6><h3 id="total-return">0.00%</h3></div></div>
                        <div class="col-md-3"><div class="metric-card"><h6>Sharpe Ratio</h6><h3 id="sharpe-ratio">0.00</h3></div></div>
                        <div class="col-md-3"><div class="metric-card"><h6>Max Drawdown</h6><h3 id="max-drawdown">0.00%</h3></div></div>
                        <div class="col-md-3"><div class="metric-card"><h6>Win Rate</h6><h3 id="overall-win-rate">0.00%</h3></div></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6"><canvas id="returns-chart"></canvas></div>
                        <div class="col-md-6"><canvas id="drawdown-chart"></canvas></div>
                    </div>
                </div>

                <!-- Risk Management Page -->
                <div id="risk-page" class="page-content" style="display:none;">
                    <h3>Risk Management</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card"><div class="card-header"><h5>Risk Limits</h5></div>
                            <div class="card-body">
                                <form id="risk-limits-form">
                                    <div class="mb-3"><label>Max Drawdown (%)</label>
                                        <input type="number" class="form-control" id="max-drawdown-limit" step="0.01"></div>
                                    <div class="mb-3"><label>Max Position Size (%)</label>
                                        <input type="number" class="form-control" id="max-position-size" step="0.01"></div>
                                    <div class="mb-3"><label>Daily Loss Limit (%)</label>
                                        <input type="number" class="form-control" id="daily-loss-limit" step="0.01"></div>
                                    <button type="submit" class="btn btn-primary">Update Limits</button>
                                </form>
                            </div></div>
                        </div>
                        <div class="col-md-6">
                            <div class="card"><div class="card-header"><h5>Current Risk Status</h5></div>
                            <div class="card-body" id="risk-status"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Logs Page -->
                <div id="logs-page" class="page-content" style="display:none;">
                    <h3>System Logs</h3>
                    <div class="mb-3">
                        <select class="form-select" id="log-level-filter" onchange="filterLogs()">
                            <option value="ALL">All Levels</option>
                            <option value="DEBUG">Debug</option>
                            <option value="INFO">Info</option>
                            <option value="WARNING">Warning</option>
                            <option value="ERROR">Error</option>
                        </select>
                    </div>
                    <div class="log-container" id="log-container"></div>
                </div>

                <!-- ML Training Page -->
                <div id="ml-train-page" class="page-content" style="display:none;">
                    <h3>Train Bot (ML/AI)</h3>
                    <form id="training-form">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label>Training Type</label>
                                <select id="training-type" class="form-select">
                                    <option value="supervised">Supervised</option>
                                    <option value="reinforcement">Reinforcement</option>
                                    <option value="deep">Deep Learning</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label>Symbol</label>
                                <select id="training-symbol" class="form-select">
                                    <option value="BTC">BTC</option>
                                    <option value="ETH">ETH</option>
                                    <option value="SOL">SOL</option>
                                    <option value="DOGE">DOGE</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label>Window Size</label>
                                <select id="training-window" class="form-select">
                                    <option value="7">7 days</option>
                                    <option value="14">14 days</option>
                                    <option value="30">30 days</option>
                                    <option value="90">90 days</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">Start Training</button>
                            </div>
                        </div>
                    </form>
                    <div class="training-status mt-3">
                        <h5>Status</h5>
                        <div id="training-status-text">Idle</div>
                        <div class="progress-bar">
                            <div id="training-progress-bar" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <span>Model Status: <span id="model-status"></span></span>
                        <span class="ms-3">Last Training: <span id="last-training"></span></span>
                        <span class="ms-3">Accuracy: <span id="model-accuracy"></span></span>
                    </div>
                </div>

                <!-- Crypto Prices Page -->
                <div id="crypto-prices-page" class="page-content" style="display:none;">
                    <h3>Crypto Prices</h3>
                    <label for="price-provider">Price Provider:</label>
                    <select id="price-provider" class="form-select w-auto d-inline-block ms-2" onchange="loadCryptoPrices()">
                        <option value="coingecko">CoinGecko</option>
                        <option value="coinmarketcap">CoinMarketCap</option>
                    </select>
                    <table id="crypto-table" class="table table-sm mt-3">
                        <thead>
                            <tr>
                                <th>Symbol</th><th>Name</th><th>Price (USD)</th><th>24h Change</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- System Status Page -->
                <div id="system-status-page" class="page-content" style="display:none;">
                    <h3>System Status</h3>
                    <div>
                        <strong>Alpaca Connection (<span id="alpaca-api-url">https://paper-api.alpaca.markets</span>):</strong>
                        <span id="alpaca-status" class="status-dot status-offline"></span>
                        <span id="alpaca-status-text">Checking...</span>
                    </div>
                    <div id="alpaca-account-status" class="mt-2"></div>
                </div>

                <!-- Chat Page -->
                <div id="chat-page" class="page-content" style="display:none;">
                    <h3>AI Chat</h3>
                    <div id="chat-messages" style="height:200px;overflow-y:auto;background:#f7f7f7;padding:8px;margin-bottom:8px;"></div>
                    <div class="input-group">
                        <input id="chat-input" type="text" class="form-control" placeholder="Type a message..." onkeypress="handleChatKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings-page" class="page-content" style="display:none;">
                    <h3>Settings</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card"><div class="card-header"><h5>Bot Configuration</h5></div>
                            <div class="card-body">
                                <form id="bot-config-form">
                                    <div class="mb-3">
                                        <label>Trading Mode</label>
                                        <select class="form-select" id="trading-mode" disabled>
                                            <option value="paper" selected>Paper Trading Only</option>
                                        </select>
                                        <small class="text-muted">Live trading is disabled for safety.</small>
                                    </div>
                                    <div class="mb-3">
                                        <label>Update Interval (seconds)</label>
                                        <input type="number" class="form-control" id="update-interval" min="1">
                                    </div>
                                    <div class="mb-3">
                                        <label>Max Positions</label>
                                        <input type="number" class="form-control" id="max-positions" min="1">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                                </form>
                            </div></div>
                        </div>
                        <div class="col-md-6">
                            <div class="card"><div class="card-header"><h5>Notifications</h5></div>
                            <div class="card-body">
                                <form id="notification-config-form">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="email-notifications">
                                        <label class="form-check-label">Email Notifications</label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="telegram-notifications">
                                        <label class="form-check-label">Telegram Notifications</label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="discord-notifications">
                                        <label class="form-check-label">Discord Notifications</label>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Save Settings</button>
                                </form>
                            </div></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create Order Modal -->
    <div class="modal fade" id="createOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-order-form">
                        <div class="mb-3">
                            <label>Symbol</label>
                            <input type="text" class="form-control" id="order-symbol" placeholder="BTCUSD" required>
                        </div>
                        <div class="mb-3">
                            <label>Side</label>
                            <select class="form-select" id="order-side" required>
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Type</label>
                            <select class="form-select" id="order-type" required>
                                <option value="market">Market</option>
                                <option value="limit">Limit</option>
                            </select>
                        </div>
                        <div class="mb-3" id="price-field" style="display:none;">
                            <label>Price</label>
                            <input type="number" class="form-control" id="order-price" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label>Amount</label>
                            <input type="number" class="form-control" id="order-amount" step="0.001" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createOrder()">Create Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts: Bootstrap, Chart.js, Custom Dashboard Logic -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/dashboard.js"></script>
    <script>
        // Sidebar navigation logic: show/hide sections
        document.querySelectorAll('#nav-sections .nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('#nav-sections .nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                // Hide all pages
                document.querySelectorAll('.page-content').forEach(page => page.style.display = 'none');
                // Show selected
                const pageId = this.getAttribute('data-page');
                let sel = document.getElementById(pageId + '-page');
                if (!sel && pageId === "overview") sel = document.getElementById("overview-page");
                if (sel) sel.style.display = '';
                if (pageId === "crypto-prices") loadCryptoPrices();
                if (pageId === "system-status") checkAlpacaStatus();
                if (pageId === "ml-train") loadMLStatus();
            });
        });
        // On page load, show overview
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.page-content').forEach((el, i) => el.style.display = i === 0 ? '' : 'none');
        });
    </script>
</body>
</html>